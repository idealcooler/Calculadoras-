<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Curva ABC Simplificada</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js">
function exportarExcel() {
  const table = document.getElementById("tabela");
  const wb = XLSX.utils.table_to_book(table, { sheet: "Curva ABC" });
  XLSX.writeFile(wb, "curva_abc.xlsx");
}

function exportarPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("Curva ABC", 14, 16);
  doc.autoTable({ html: '#tabela', startY: 20 });
  doc.save("curva_abc.pdf");
}

function filtrarCategoria() {
  const filtro = document.getElementById("filtroCategoria").value;
  const linhas = document.querySelectorAll("#tabela tbody tr");
  linhas.forEach(linha => {
    const cat = linha.children[6].textContent.trim();
    linha.style.display = (filtro === "" || cat === filtro) ? "" : "none";
  });
}

async function carregarPedidosLojaIntegrada() {
  const email = "4744060a5e00f1f98672";
  const key = "9f43d27a446caf695bc7";
  const hoje = new Date();
  const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1).toISOString().split('T')[0];
  const ultimoDia = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0).toISOString().split('T')[0];

  let url = `https://api.awsli.com.br/v1/pedido/?data_criacao__gte=${primeiroDia}&data_criacao__lte=${ultimoDia}&limit=100`;
  let headers = {
    "Content-Type": "application/json",
    "X-API-EMAIL": email,
    "X-API-KEY": key
  };

  let todosPedidos = [];
  while (url) {
    const res = await fetch(url, { headers });
    const data = await res.json();
    todosPedidos.push(...data.objects);
    url = data.meta?.next;
  }

  let mapa = {};
  todosPedidos.forEach(pedido => {
    pedido.itens.forEach(item => {
      const nome = item.produto.nome;
      const quantidade = item.quantidade;
      const valor_unitario = parseFloat(item.preco);
      if (!mapa[nome]) {
        mapa[nome] = { nome, unidades: 0, unitario: valor_unitario };
      }
      mapa[nome].unidades += quantidade;
    });
  });

  produtos = Object.values(mapa);
  localStorage.setItem("produtosABC", JSON.stringify(produtos));
  atualizarTabela();
}

window.onload = () => {
  carregarPedidosLojaIntegrada();
};
</script>


  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 30px; display: flex; justify-content: center; }
    .container { background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 1000px; }
    h1 { text-align: center; margin-bottom: 20px; }
    .form-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
    input, button { padding: 10px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; }
    input { flex: 1; min-width: 200px; }
    button { background: #007bff; color: white; border: none; cursor: pointer; }
    button#limpar { background: #dc3545; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background: #f2f2f2; }
    canvas { margin-top: 40px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Calculadora de Curva ABC</h1>
    
    <div class="form-group">
      <button onclick="exportarExcel()" style="background:#198754;">Exportar Excel</button>
      <button onclick="exportarPDF()" style="background:#6c757d;">Exportar PDF</button>
      <select id="filtroCategoria" onchange="filtrarCategoria()" style="padding:10px;border-radius:8px;">
        <option value="">Todas as Categorias</option>
        <option value="A">A</option>
        <option value="B">B</option>
        <option value="C">C</option>
      </select>
    </div>
    <div class="form-group">

      <input type="text" id="produto" placeholder="Nome do Produto">
      <input type="number" id="unitarioProduto" placeholder="Valor Unitário (R$)">
      <input type="number" id="unidadesProduto" placeholder="Unidades Vendidas">
      <button onclick="adicionarProduto()">Adicionar</button>
      <button id="limpar" onclick="limparDados()">Limpar Dados</button>
    </div>

    <table id="tabela">
      <thead>
        <tr>
          <th>Produto</th>
          <th>Valor Unitário</th>
          <th>Valor Total</th>
          <th>Unidades</th>
          <th>% Acumulado</th>
          <th>% Acumulado</th><th>Categoria</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <canvas id="grafico" height="300"></canvas>
  </div>

<script>
  let produtos = JSON.parse(localStorage.getItem("produtosABC")) || [];
  let chart;

  function adicionarProduto() {
    const nome = document.getElementById("produto").value.trim();
    const unitario = parseFloat(document.getElementById("unitarioProduto").value);
    const unidades = parseInt(document.getElementById("unidadesProduto").value);

    if (!nome || isNaN(unitario) || isNaN(unidades)) {
      alert("Preencha todos os campos corretamente.");
      return;
    }

    produtos.push({ nome, unitario, unidades });
    localStorage.setItem("produtosABC", JSON.stringify(produtos));

    document.getElementById("produto").value = '';
    document.getElementById("unitarioProduto").value = '';
    document.getElementById("unidadesProduto").value = '';
    atualizarTabela();
  }

  function limparDados() {
    if (confirm("Deseja realmente apagar todos os produtos salvos?")) {
      produtos = [];
      localStorage.removeItem("produtosABC");
      atualizarTabela();
    }
  }

  function atualizarTabela() {
    const recalculado = produtos.map(p => {
      const valor = p.unitario * p.unidades;
      return { ...p, valor };
    });

    const total = recalculado.reduce((acc, p) => acc + p.valor, 0);
    const ordenados = [...recalculado].sort((a, b) => b.valor - a.valor);

    let resultado = [];
    
    let acumulado = 0;
    ordenados.forEach((p) => {
      acumulado += p.valor;
      const percentualAcumulado = (acumulado / total) * 100;
      let categoria = 'C';
      if (percentualAcumulado <= 80) categoria = 'A';
      else if (percentualAcumulado <= 95) categoria = 'B';
      resultado.push({ ...p, percentual: percentualAcumulado.toFixed(0) + '%', categoria });
    });
    
      const percentual = ((p.valor / total) * 100);
      let categoria = 'C';
      if (i < Math.ceil(ordenados.length * 0.2)) categoria = 'A';
      else if (i < Math.ceil(ordenados.length * 0.5)) categoria = 'B';
      resultado.push({ ...p, percentual: percentual.toFixed(0) + '%', categoria });
    });

    const tbody = document.querySelector("#tabela tbody");
    tbody.innerHTML = "";
    resultado.forEach(p => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${p.nome}</td>
        <td>R$ ${p.unitario.toFixed(2)}</td>
        <td>R$ ${p.valor.toFixed(2)}</td>
        <td>${p.unidades}</td>
        <td>${p.percentual}</td>
        <td>${p.categoria}</td>
      `;
      tbody.appendChild(row);
    });

    desenharGrafico(resultado);
  }

  function desenharGrafico(dados) {
    const ctx = document.getElementById("grafico").getContext("2d");
    if (chart) chart.destroy();

    chart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: dados.map(p => p.nome),
        datasets: [{
          label: "Vendas por Produto (R$)",
          data: dados.map(p => p.valor),
          backgroundColor: dados.map(p =>
            p.categoria === 'A' ? '#4caf50' : p.categoria === 'B' ? '#ff9800' : '#f44336'
          )
        }]
      },
      options: {
        indexAxis: 'y',
        plugins: {
          title: {
            display: true,
            text: "Distribuição de Vendas por Produto"
          },
          legend: { display: false }
        },
        responsive: true,
        scales: {
          x: { beginAtZero: true }
        }
      }
    });
  }

  window.onload = () => {
    if (produtos.length > 0) atualizarTabela();
  };

function exportarExcel() {
  const table = document.getElementById("tabela");
  const wb = XLSX.utils.table_to_book(table, { sheet: "Curva ABC" });
  XLSX.writeFile(wb, "curva_abc.xlsx");
}

function exportarPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("Curva ABC", 14, 16);
  doc.autoTable({ html: '#tabela', startY: 20 });
  doc.save("curva_abc.pdf");
}

function filtrarCategoria() {
  const filtro = document.getElementById("filtroCategoria").value;
  const linhas = document.querySelectorAll("#tabela tbody tr");
  linhas.forEach(linha => {
    const cat = linha.children[6].textContent.trim();
    linha.style.display = (filtro === "" || cat === filtro) ? "" : "none";
  });
}

async function carregarPedidosLojaIntegrada() {
  const email = "4744060a5e00f1f98672";
  const key = "9f43d27a446caf695bc7";
  const hoje = new Date();
  const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1).toISOString().split('T')[0];
  const ultimoDia = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0).toISOString().split('T')[0];

  let url = `https://api.awsli.com.br/v1/pedido/?data_criacao__gte=${primeiroDia}&data_criacao__lte=${ultimoDia}&limit=100`;
  let headers = {
    "Content-Type": "application/json",
    "X-API-EMAIL": email,
    "X-API-KEY": key
  };

  let todosPedidos = [];
  while (url) {
    const res = await fetch(url, { headers });
    const data = await res.json();
    todosPedidos.push(...data.objects);
    url = data.meta?.next;
  }

  let mapa = {};
  todosPedidos.forEach(pedido => {
    pedido.itens.forEach(item => {
      const nome = item.produto.nome;
      const quantidade = item.quantidade;
      const valor_unitario = parseFloat(item.preco);
      if (!mapa[nome]) {
        mapa[nome] = { nome, unidades: 0, unitario: valor_unitario };
      }
      mapa[nome].unidades += quantidade;
    });
  });

  produtos = Object.values(mapa);
  localStorage.setItem("produtosABC", JSON.stringify(produtos));
  atualizarTabela();
}

window.onload = () => {
  carregarPedidosLojaIntegrada();
};
</script>


</body>
</html>
