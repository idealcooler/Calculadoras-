
<!DOCTYPE html>

<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Curva ABC Simplificada</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js">
function exportarExcel() {
  const table = document.getElementById("tabela");
  const wb = XLSX.utils.table_to_book(table, { sheet: "Curva ABC" });
  XLSX.writeFile(wb, "curva_abc.xlsx");
}

function exportarPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("Curva ABC", 14, 16);
  doc.autoTable({ html: '#tabela', startY: 20 });
  doc.save("curva_abc.pdf");
}

function filtrarCurva() {
  const filtro = document.getElementById("filtroCurva").value;
  const linhas = document.querySelectorAll("#tabela tbody tr");
  linhas.forEach(linha => {
    const cat = linha.children[6].textContent.trim();
    linha.style.display = (filtro === "" || cat === filtro) ? "" : "none";
  });
}

function buscarMesSelecionado() {
  const input = document.getElementById("mesSelecionado");
  const mes = input.value;
  if (mes) {
    localStorage.setItem("mesSelecionado", mes);
    fetch(`https://curva-abc-proxy.onrender.com/api/pedidos?mes=${mes}`)
      .then(res => res.json())
      .then(produtosAPI => {
        produtos = produtosAPI;
        localStorage.setItem("produtosABC", JSON.stringify(produtos));
        atualizarTabela();
      })
      .catch(err => {
        console.error("Erro ao buscar dados:", err);
      });
  }
}

window.onload = () => {
  const mesSalvo = localStorage.getItem("mesSelecionado");
  const input = document.getElementById("mesSelecionado");
  const hoje = new Date();
  const defaultMes = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;
  input.value = mesSalvo || defaultMes;
  buscarMesSelecionado();
};

function adicionarProduto() {
  const nome = document.getElementById("produto").value.trim();
  const unitario = parseFloat(document.getElementById("unitarioProduto").value);
  const unidades = parseInt(document.getElementById("unidadesProduto").value);

  if (!nome || isNaN(unitario) || isNaN(unidades)) {
    alert("Preencha todos os campos corretamente.");
    return;
  }

  produtos.push({ nome, unitario, unidades });
  localStorage.setItem("produtosABC", JSON.stringify(produtos));

  document.getElementById("produto").value = '';
  document.getElementById("unitarioProduto").value = '';
  document.getElementById("unidadesProduto").value = '';
  atualizarTabela();
}
</script>
<script>
let produtos = [];

function adicionarProduto() {
  const nome = document.getElementById("produto").value.trim();
  const unitario = parseFloat(document.getElementById("unitarioProduto").value);
  const unidades = parseInt(document.getElementById("unidadesProduto").value);

  if (!nome || isNaN(unitario) || isNaN(unidades)) {
    alert("Preencha todos os campos corretamente.");
    return;
  }

  produtos.push({ nome, unitario, unidades });
  localStorage.setItem("produtosABC", JSON.stringify(produtos));
  document.getElementById("produto").value = '';
  document.getElementById("unitarioProduto").value = '';
  document.getElementById("unidadesProduto").value = '';
  atualizarTabela();
}

function limparDados() {
  if (confirm("Deseja apagar todos os produtos salvos?")) {
    produtos = [];
    localStorage.removeItem("produtosABC");
    atualizarTabela();
  }
}

window.onload = () => {
  fetch("https://curva-abc-proxy.onrender.com/api/pedidos")
    .then(res => res.json())
    .then(produtosAPI => {
      if (Array.isArray(produtosAPI) && produtosAPI.length > 0) {
        produtos = produtosAPI;
        localStorage.setItem("produtosABC", JSON.stringify(produtos));
        atualizarTabela();
      } else {
        alert("Nenhum dado encontrado na Loja Integrada.");
        produtos = [];
        atualizarTabela();
      }
    })
    .catch(err => {
      console.error("Erro ao buscar dados:", err);
      alert("Erro ao carregar dados da API.");
    });
}
</script>
