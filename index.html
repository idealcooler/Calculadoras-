<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calculadora de Curva ABC</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    textarea { width: 100%; height: 120px; margin-bottom: 10px; }
    button { margin-right: 10px; padding: 8px 16px; }
    pre { background: #f4f4f4; padding: 10px; white-space: pre-wrap; }
    canvas { margin-top: 30px; }
  </style>
</head>
<body>
  <h1>Calculadora de Curva ABC</h1>
  <textarea id="input" placeholder="Produto A,100\nProduto B,50\nProduto C,30"></textarea>
  <br/>
  <button onclick="calcular()">Calcular</button>
  <button onclick="exportarCSV()">Exportar CSV</button>
  <pre id="resultado"></pre>
  <canvas id="grafico" width="600" height="300"></canvas>

  <script>
    let classificadosGlobal = [];

    function calcular() {
      const input = document.getElementById('input').value.trim();
      const linhas = input.split('\\n');
      const itens = [];

      try {
        linhas.forEach(linha => {
          const [nome, valor] = linha.split(',');
          itens.push({ nome: nome.trim(), valor: parseFloat(valor) });
        });

        const total = itens.reduce((soma, item) => soma + item.valor, 0);
        const ordenados = [...itens].sort((a, b) => b.valor - a.valor);

        let acumulado = 0;
        const classificados = ordenados.map(item => {
          acumulado += item.valor;
          const percentual = (acumulado / total) * 100;
          let categoria = 'C';
          if (percentual <= 80) categoria = 'A';
          else if (percentual <= 95) categoria = 'B';
          return { ...item, categoria };
        });

        classificadosGlobal = classificados;

        const resultado = classificados.map(i => ${i.nome}: ${i.valor.toFixed(2)} - ${i.categoria}).join('\\n');
        document.getElementById('resultado').textContent = resultado;

        renderizarGrafico(classificados);
      } catch (e) {
        document.getElementById('resultado').textContent = 'Erro: Verifique o formato dos dados.';
      }
    }

    function exportarCSV() {
      if (!classificadosGlobal.length) return;
      const cabecalho = 'Nome,Valor,Categoria';
      const linhas = classificadosGlobal.map(i => ${i.nome},${i.valor},${i.categoria});
      const csv = [cabecalho, ...linhas].join('\\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'curva_abc.csv';
      link.click();
    }

    function renderizarGrafico(dados) {
      const ctx = document.getElementById('grafico').getContext('2d');
      if (window.graficoABC) window.graficoABC.destroy();

      window.graficoABC = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: dados.map(d => d.nome),
          datasets: [{
            label: 'Valor',
            data: dados.map(d => d.valor),
            backgroundColor: dados.map(d => 
              d.categoria === 'A' ? '#4caf50' : d.categoria === 'B' ? '#ff9800' : '#f44336'
            )
          }]
        },
        options: {
          responsive: true,
          plugins: {
            tooltip: { mode: 'index', intersect: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }
  </script>
</body>
</html>
